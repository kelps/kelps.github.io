---
layout: blogger
title: Interação com Silverlight – Parte 1 – Passando Parâmetros
date: 2009-05-22T10:54:00.0010000-03:00
permalink: /:year/:month/:slug:output_ext
tags: [Dicas, Silverlight]
---
<p>Há diversas formas de interagir e trocar informações com aplicações Silverlight mas não há muita informação, principalmente em português, sobre como elas funcionam e como utilizá-las. Por conta disso, hoje eu começo uma série de posts com dicas de como interagir com aplicações Silverlight. No final deste post eu vou colocar links para todos os outros posts desta série, conforme eles forem publicados.</p>  <p>Neste post vou falar sobre passagem de parâmetros.</p>  <p>Há diversos cenários onde sua aplicação Silverlight necessitará receber parâmetros externos para poder funcionar. Por exemplo: Você pode desenvolver um vídeo player e quando for colocá-lo em sua página terá que passar como parâmetro a url do vídeo que o player irá exibir. </p>  <p>A forma de fazer isso em Silverlight é muito semelhante à abordagem do Flash. Como vocês já devem saber a essa altura, o Silverlight (assim como o Flash) é um plugin do browser que é colocado na página utilizando a tag <font color="#0000ff" face="Courier New"><<font color="#a41515">object</font>></font>. Essa tag object pode conter uma série de tags <font color="#0000ff" face="Courier New"><<font color="#a41515">param</font>></font> que possuem propriedades name e value e servem para configurar o plugin. Em Flash, quando é necessário passar algum parâmetro é utilizado o <font color="#0000ff" face="Courier New"><<font color="#a41515">param</font>></font> “<strong>flashvars</strong>” e os parâmetros são passados de forma semelhante a parâmetros passados na url para uma página .aspx. Em Silverlight é utilizado o <font color="#0000ff" face="Courier New"><<font color="#a41515">param</font>></font> “<strong>initParams</strong>”, onde são passados chaves e valores separados por “,'” (vírgula). Atualmente há uma limitação nessa forma de passar parâmetros pois não há um encode automático de “,” ou “=” então, se o seu parâmetro tiver algum desses caracteres será necessário encodá-los manualmente de alguma forma. </p>  <p>Segue abaixo um exemplo de um player de vídeo em Silverlight, onde são passados como parâmetros o nome do arquivo de vídeo e um segundo parâmetro informado o modo de auto play:</p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code><font color="#0000ff"><<font color="#a41515">object</font> <font color="#ff0000">width</font>="100%" <font color="#ff0000">height</font>="100%" <font color="#ff0000">data</font>="data:application/x-silverlight-2," <font color="#ff0000">type</font>="application/x-silverlight-2">         <br />    <<font color="#a41515">param</font> <font color="#ff0000">name</font>="source" <font color="#ff0000">value</font>="/ClientBin/player.xap"/>         <br />    <<font color="#a41515">param</font> <font color="#ff0000">name</font>="initParams" <font color="#ff0000">value</font>="video=meu-video.wmv,autoplay=false"/>         <br /></<font color="#a41515">object</font>></font></code></p>  <p>Em páginas .aspx pode ser utilizado o server control do Silverlight, como no exemplo abaixo:</p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code><font color="#0000ff"><<font color="#a41515">asp</font>:<font color="#a41515">Silverlight</font> <font color="#ff0000">runat</font>="server" <font color="#ff0000">Source</font>="~/ClientBin/player.xap" <font color="#ff0000">Width</font>="100%" <font color="#ff0000">Height</font>="100%" <font color="#ff0000">InitParameters</font>="video=meu-video.wmv,autoplay=false" /></font></code></p>  <p>Mas aí você me pergunta: Como eu faço para ler esses parâmetros? </p>  <p>Em páginas .aspx, quando passamos parâmetros na url utilizamos o Request[<font color="#a41515">“nome_do_parametro”</font>] para fazer a leitura. No Silverlight é um pouco diferente. Os parâmetros são encarados como sendo informações de inicialização da aplicação e, portanto, só há um lugar onde eles podem ser acessados que é a partir de um event handler do evento Startup da aplicação (a classe App do seu projeto Silverlight). Abaixo segue um exemplo de código para ler esses parâmetros:</p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code><font color="#0000ff">public static void</font> Application_Startup(<font color="#0000ff">object</font> sender, <font color="#2c92af">StartupEventArgs</font> e) {       <br />    <font color="#0000ff">this</font>.RootVisual = new <font color="#2c92af">Page</font>();       <br />      <br />    <font color="#0000ff">string</font> movie = e.InitParams[<font color="#a41515">"video"</font>];       <br />    <font color="#0000ff">bool</font> autoplay = <font color="#0000ff">false</font>;       <br />    <font color="#0000ff">bool</font>.TryParse(e.InitParams[<font color="#a41515">"autoplay"</font>], <font color="#0000ff">out</font> autoplay);       <br />} </code></p>  <p>Mas agora surge outro problema: Como fazemos para o resto do código da nossa aplicação ter acesso a esses valores?</p>  <p>Isso é fácil: Podemos criar propriedades estáticas na nossa classe App e acessá-las de qualquer lugar no nosso aplicativo. Segue abaixo outro exemplo:</p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code><font color="#0000ff">public static string</font> MovieFile { <font color="#0000ff">get</font>; <font color="#0000ff">set</font>; }       <br />      <br /><font color="#0000ff">public static bool</font> AutoPlay { <font color="#0000ff">get</font>; <font color="#0000ff">set</font>; }       <br />      <br /><font color="#0000ff">public static void</font> Application_Startup(<font color="#0000ff">object</font> sender, <font color="#2c92af">StartupEventArgs</font> e) {       <br />    <font color="#0000ff">this</font>.RootVisual = new <font color="#2c92af">Page</font>();  <br />      <br />    <font color="#2c92af">App</font>.MovieFile = e.InitParams[<font color="#a41515">"video"</font>];  <br />    <font color="#2c92af">App</font>.AutoPlay = <font color="#0000ff">bool</font>.Parse(e.InitParams[<font color="#a41515">"autoplay"</font>]);       <br />} </code></p>  <p>Mas há uma coisa que me incomoda nesse código: Para cada parâmetro passado será necessário eu ler, efetuar o parse e atribuir o resultado à propriedade. Isso é tranquilo quando estamos falando de 2 ou 3 parâmetros string, mas começa a ficar complicado quando há muitos parâmetros ou quando os parâmetros são de tipos diferente de string, onde se torna necessário fazer parse. Em casos assim o código desse event handler poderia ficar grande muito rapidamente.</p>  <p>Então eu decidi pensar em como isso poderia se tornar mais fácil. Como eu gostaria que esses parâmetros funcionassem? Seria legal se eu pudesse simplesmente criar propriedades na minha classe App e marcá-las com algum atributo que indicasse que a propriedade deve ser inicializada a partir do valor passado no InitParams. Então eu pesquisei um pouco de vi que isso era de fato possível, utilizando um pouco de Reflection. Foi então que eu escrevi a classe abaixo:</p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code><font color="#0000ff">public class</font> <font color="#2c92af">InitParamAttribute</font> : <font color="#2c92af">Attribute</font> {       <br />   <font color="#0000ff">public string</font> ParamName { <font color="#0000ff">get</font>; <font color="#0000ff">private set</font>; }       <br />      <br />   <font color="#0000ff">public</font> InitParamAttribute(<font color="#0000ff">string</font> paramName) {       <br />      <font color="#0000ff">this</font>.ParamName = paramName;       <br />   }       <br />      <br />   <font color="#0000ff">public static void</font> AppStartup_Handler(<font color="#0000ff">object</font> sender, <font color="#2c92af">StartupEventArgs</font> e) {       <br />      <font color="#2c92af">Type</font> t = sender.GetType();       <br />      <font color="#0000ff">var</font> props = t.GetProperties();       <br />      <font color="#0000ff">foreach</font> (<font color="#0000ff">var</font> p <font color="#0000ff">in</font> props) {       <br />         <font color="#0000ff">foreach</font> (<font color="#0000ff">var</font> ca <font color="#0000ff">in</font> p.GetCustomAttributes(<font color="#0000ff">false</font>)) {       <br />            <font color="#0000ff">var</font> a = ca <font color="#0000ff">as</font> <font color="#2c92af">InitParamAttribute</font>;       <br />            <font color="#0000ff">if</font> (a != <font color="#0000ff">null</font> && !<font color="#0000ff">string</font>.IsNullOrEmpty(a.ParamName) && p.CanWrite && a <font color="#0000ff">is</font> InitParamAttribute) {       <br />               <font color="#0000ff">if</font> (e.InitParams.ContainsKey(a.ParamName)) {  <br />                  <font color="#0000ff">object</font> valor = <font color="#2c92af">Convert</font>.ChangeType(e.InitParams[a.ParamName], p.PropertyType, <font color="#2c92af">CultureInfo</font>.InvariantCulture);       <br />                  p.SetValue(sender, valor, <font color="#0000ff">null</font>);       <br />               }       <br />            }       <br />         }       <br />      }       <br />   }       <br />} </code></p>  <p>O que essa classe faz é ler, usando Reflection, a classe App da aplicação e listar todas suas propriedades públicas. Para cada propriedade pública que estiver marcada com o atributo InitParam, ela vai verificar se o parâmetro correspondente foi passado, executar o parse do valor e atribuir à propriedade.</p>  <p>Usando esta nova classe, agora eu posso mudar o código da minha classe App para o seguinte: </p>  <p style="border-bottom: #000 1px solid; border-left: #000 1px solid; padding-bottom: 5px; padding-left: 5px; padding-right: 5px; border-top: #000 1px solid; border-right: #000 1px solid; padding-top: 5px"><code>[<font color="#2c92af">InitParam</font>(<font color="#a41515">"video"</font>)]       <br /><font color="#0000ff">public static string</font> MovieFile { <font color="#0000ff">get</font>; <font color="#0000ff">set</font>; }       <br />      <br />[<font color="#2c92af">InitParam</font>(<font color="#a41515">"autoplay"</font>)]       <br /><font color="#0000ff">public static bool</font> AutoPlay { <font color="#0000ff">get</font>; <font color="#0000ff">set</font>; }       <br />      <br /><font color="#0000ff">public</font> App() {       <br />    <font color="#0000ff">this</font>.Startup += <font color="#0000ff">this</font>.Application_Startup;       <br />    <font color="#0000ff">this</font>.Exit += <font color="#0000ff">this</font>.Application_Exit;       <br />    <font color="#0000ff">this</font>.UnhandledException += <font color="#0000ff">this</font>.Application_UnhandledException;       <br />    <font color="#0000ff">this</font>.Startup += <font color="#2c92af">InitParamAttribute</font>.AppStartup_Handler;       <br />    InitializeComponent();       <br />}       <br />      <br /><font color="#0000ff">public static void</font> Application_Startup(<font color="#0000ff">object</font> sender, StartupEventArgs e) {       <br />    <font color="#0000ff">this</font>.RootVisual = new <font color="#2c92af">Page</font>();       <br />} </code></p>  <p>Agora basta acessar essas propriedades de qualquer lugar do meu aplicativo Silverlight, utilizado por exemplo App.MovieFile. Se eu quiser passar mais parâmetros para a aplicação, basta criar mais propriedades e marcá-las com esse atributo.</p>  <p>É claro que é possível melhorar o código apresentado aqui. Umas das melhorias poderia ser, por exemplo, informar se o parâmetro é obrigatório ou não e lançar uma excessão caso seja obrigatório e não tenha sido passado, mas do jeito que está já serve para ilustrar como passar e utilizar parâmetros em aplicações Silverlight de forma eficiente e sem perder tempo escrevendo código de validação e tratamento de input.</p>  <p>Espero que este pequeno tutorial seja útil. Em breve darei continuidade a esta série escrevendo sobre outras formas de interagir com aplicações Silverlight.</p>  <p><strong>Dicas sobre interação com aplicações Silverlight</strong></p>  <ul>   <li>Interação com Silverlight – Parte 1 – Passando Parâmetros </li> </ul>  
