---
layout: blogger
title: Busca por controles na árvore visual de aplicações Silverlight e WPF
date: 2011-07-29T19:13:00.0010000-03:00
permalink: /:year/:month/:slug:output_ext
tags: [Dicas, Silverlight, Código]
---
<p>Ontem eu vi uma pergunta no <a href="http://social.msdn.microsoft.com/Forums/pt-BR/silverlightpt/threads">fórum de Silverlight do MSDN</a> sobre <a href="http://social.msdn.microsoft.com/Forums/pt-BR/silverlightpt/thread/d862de91-2e02-4808-9d55-9c7157e99e26">como achar todos os campos TextBox que existem dentro de uma ChildWindow</a>. Já havia algumas respostas para a pergunta mas elas eram bem pontuais para aquele problema específico e necessitavam de várias suposições sobre a estrutura da aplicação para funcionar sem problemas (por exemplo, saber quais tipos de Panel estão sendo usados). Alguns anos atrás, quando eu comecei a fazer uma das minhas primeiras behaviors para publicar na <a href="http://gallery.expression.microsoft.com/site/search?f%5B0%5D.Type=User&f%5B0%5D.Value=Kelps%20Leite%20de%20Sousa&f%5B0%5D.Text=Kelps%20Leite%20de%20Sousa">galeria do Expression Blend</a>, eu descobri uma classe do Silverlight (também existe no WPF) que serve justamente para permitir navergarmos na árvore visual de uma aplicação, tanto procurando controles filhos quanto pais de um determinado controle.</p> <p>A behavior em questão é a que permitia que se fizesse <a href="http://gallery.expression.microsoft.com/MouseWheelScroll">scroll com a wheel do mouse (a rodinha) em controles que apresentassem scrollbar para aplicações feitas em Silverlight 3</a>. Hoje essa behavior praticamente não é mais necessárias pois o Silverlight 4 já implementa esse comportamento nativamente, mas não era esse o caso na época. Para poder implementar essa função eu precisei criar um código que fosse capaz de ler toda a hierarquia visual do controle (vasculhando todos os componentes do qual o template do controle era composto), procurando por algum ScrollViewer. Se eu o encontrasse, a behavior assinava os eventos necessários do controle para que o scroll funcionasse como esperado.</p> <p>Para navegar pela árvore visual, a classe que utilizei foi a VisualTreeHelper. Voltando à dúvida do fórum, eu decidi criar um método genérico que fosse capaz de encontrar todos os controles de um determinado tipo em uma hierárquia utilizando essa classe, assim estaria garantindo que não precisaria ficar colocando “if”s para cada tipo de painel diferente que aparecesse na minha frente. Sem mais delongas, segue abaixo o método que eu fiz.</p><pre style="line-height: normal; font-family: ; background: white; color: "><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 9.8pt">public</font></font></span><font style="font-size: 9.8pt"><font color="#000000"> </font><span style="color: "><font color="#0000ff">static</font></span><font color="#000000"> T[] SearchUIElements<T>(</font><span style="color: "><font color="#2b91af">UIElement</font></span><font color="#000000"> root, </font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000"> maxlevel = </font><span style="color: "><font color="#0000ff">int</font></span><font color="#000000">.MaxValue, </font><span style="color: "><font color="#0000ff">int</font></span></font></font><font style="font-size: 9.8pt"><font face="Consolas"><font color="#000000"> level = 0) <br>    </font><span style="color: "><font color="#0000ff">where</font></span><font color="#000000"> T : </font><span style="color: "><font color="#2b91af">UIElement</font></span></font><font face="Consolas"><font color="#000000"> {<br> <br>    </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> result = </font><span style="color: "><font color="#0000ff">new</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">List</font></span></font><font face="Consolas"><font color="#000000"><T>();<br> <br>    </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (root != </font><span style="color: "><font color="#0000ff">null</font></span></font><font face="Consolas"><font color="#000000">) {<br>        </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (root </font><span style="color: "><font color="#0000ff">is</font></span></font><font face="Consolas"><font color="#000000"> T) {<br>            result.Add(root </font><span style="color: "><font color="#0000ff">as</font></span></font><font face="Consolas"><font color="#000000"> T);<br>        }<br> <br>        </font><span style="color: "><font color="#0000ff">if</font></span></font><font face="Consolas"><font color="#000000"> (level < maxlevel) {<br>            </font><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> childrencount = </font><span style="color: "><font color="#2b91af">VisualTreeHelper</font></span></font><font face="Consolas"><font color="#000000">.GetChildrenCount(root);<br>            </font><span style="color: "><font color="#2b91af">DependencyObject</font></span></font><font face="Consolas"><font color="#000000"> child;<br>            </font><span style="color: "><font color="#0000ff">for</font></span><font color="#000000"> (</font><span style="color: "><font color="#0000ff">var</font></span></font><font face="Consolas"><font color="#000000"> i = 0; i < childrencount; i++) {<br>                child = </font><span style="color: "><font color="#2b91af">VisualTreeHelper</font></span></font><font face="Consolas"><font color="#000000">.GetChild(root, i);<br>                </font><span style="color: "><font color="#0000ff">if</font></span><font color="#000000"> (child </font><span style="color: "><font color="#0000ff">is</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">UIElement</font></span></font><font face="Consolas"><font color="#000000">) {<br>                    result.AddRange(SearchUIElements<T>(child </font><span style="color: "><font color="#0000ff">as</font></span><font color="#000000"> </font><span style="color: "><font color="#2b91af">UIElement</font></span></font></font><font face="Consolas"><font style="font-size: 9.8pt"><font color="#000000">, maxlevel, level + 1));<br>                }<br>            }<br>        }<br>    }<br> <br>    </font><span style="color: "><font color="#0000ff">return</font></span><font color="#000000"> result.ToArray();<br>}</font></font></font></pre><br /><p>Como vocês podem ver o método não é grande e é bem simples. Ele aceita 3 parâmetros:</p><br /><ul><br /><li><strong>root</strong>: controle raiz a partir de onde será iniciada a busca. Por exemplo: LayoutRoot. <br /><li><strong>maxlevel</strong>: número máximo de níveis que a busca irá “descer” nos descendentes. Este parâmetro é opcional e o seu valor padrão é int.MaxValue, garantindo que será lida a hierarquia inteira a partir do ponto inicial. <br /><li><strong>level</strong>: nível atual da busca. Esse parâmetro é utilizado apenas pela própria função para controlar quando a busca atingirá o nível máximo solicitado pelo usuário.</li></ul><br /><p>A função é genérica. O parâmetro T serve para indicar qual tipo de controle será procurado, assim como permitir que o retorno sejá tipado corretamente. A é executada de forma recursiva, chamando a si mesma para cada novo ítem na hierarquia.</p><br /><p>O resultado da função é sempre um array do tipo de controle solicitado. Esta função sempre retorna uma array, mesmo que seja vazio (não será retornado null). </p><br /><p>Abaixo temos um xaml de exemplo e algumas chamada à função com a descrição do que será encontrado em cada caso.</p><pre style="line-height: normal; font-family: ; background: white; color: "><font face="Consolas"><span style="color: "><font color="#0000ff"><font style="font-size: 9.8pt"><</font></font></span><font style="font-size: 9.8pt"><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#ff0000"> x</font></span><span style="color: "><font color="#0000ff">:</font></span><span style="color: "><font color="#ff0000">Name</font></span><font color="#0000ff"><span style="color: ">=</span><span style="color: ">"LayoutRoot"</span><span style="color: ">></span></font><br /><span style="color: "><font color="#a31515">    </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">TextBox</font></span><span style="color: "><font color="#0000ff"> /></font></span><br /><span style="color: "><font color="#a31515">    </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">TextBox</font></span><span style="color: "><font color="#0000ff"> /></font></span><br /><span style="color: "><font color="#a31515">    </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#0000ff">></font></span><br /><span style="color: "><font color="#a31515">        </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">TextBox</font></span><span style="color: "><font color="#0000ff"> /></font></span><br /><span style="color: "><font color="#a31515">        </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">TextBox</font></span><span style="color: "><font color="#0000ff"> /></font></span><br /><span style="color: "><font color="#a31515">        </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#0000ff">></font></span><br /><span style="color: "><font color="#a31515">            </font></span><span style="color: "><font color="#0000ff"><</font></span><span style="color: "><font color="#a31515">TextBox</font></span><span style="color: "><font color="#0000ff"> /></font></span><br /><span style="color: "><font color="#a31515">        </font></span><span style="color: "><font color="#0000ff"></</font></span><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#0000ff">></font></span><br /><span style="color: "><font color="#a31515">    </font></span><span style="color: "><font color="#0000ff"></</font></span><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#0000ff">></font></span><br /><span style="color: "><font color="#0000ff"></</font></span><span style="color: "><font color="#a31515">Grid</font></span><span style="color: "><font color="#0000ff">></font></span><br /></font></font></pre><pre style="line-height: normal; font-family: ; background: white; color: "><font face="Consolas"><span style="color: "><font color="#008000"><font style="font-size: 9.8pt">//acha TODOS os 5 campos TextBox </font></font></span><font style="font-size: 9.8pt"><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> textboxes = SearchUIElements<</font><span style="color: "><font color="#2b91af">TextBox</font></span></font></font><font style="font-size: 9.8pt"><font face="Consolas"><font color="#000000">>(LayoutRoot);<br /> <br /></font><span style="color: "><font color="#008000">//acha apenas os 2 campos TextBox de LayoutRoot</font></span><br /><font color="#000000">textboxes = SearchUIElements<</font><span style="color: "><font color="#2b91af">TextBox</font></span></font><font face="Consolas"><font color="#000000">>(LayoutRoot, 1);<br /> <br /></font><span style="color: "><font color="#008000">//acha 4. Os 2 acima e os 2 que estão no primeiro Grid filho</font></span><br /><font color="#000000">textboxes = SearchUIElements<</font><span style="color: "><font color="#2b91af">TextBox</font></span></font></font><font face="Consolas"><font style="font-size: 9.8pt"><font color="#000000">>(LayoutRoot, 2);<br /> <br /></font><span style="color: "><font color="#008000">//acha TODOS os Grids a partir de LayoutRoot, inclusive ele mesmo </font></span><br /><span style="color: "><font color="#0000ff">var</font></span><font color="#000000"> grids = SearchUIElements<</font><span style="color: "><font color="#2b91af">Grid</font></span><font color="#000000">>(LayoutRoot);         </font></font></font></pre><br /><p>Agora que eu já mostrei como faz, você acha que consegue fazer uma função semelhante que navegue ao contrário na hierárquia? (procurando nos pais de um controle até chegar na raíz da aplicação…). Fica o desafio. <img style="border-bottom-style: none; border-left-style: none; border-top-style: none; border-right-style: none" class="wlEmoticon wlEmoticon-winkingsmile" alt="Winking smile" src="http://lh3.ggpht.com/-LMChAXUOhI0/TjMvydL6SvI/AAAAAAAAA5U/s0i6CGl29to/wlEmoticon-winkingsmile%25255B2%25255D.png?imgmax=800"></p>  
