---
layout: blogger
title: Se tornado sysadmin em servidor SQL Server/Express local (revisado)
date: 2010-08-26T09:37:00.0010000-03:00
permalink: /:year/:month/:slug:output_ext
tags: [SQL, Dicas]
---
<p>Pouco mais de 1 mês atrás eu postei aqui no blog uma <a href="http://blog.kelps.net/2010/06/reset-senha-sa-sql-express.html" target="_blank">dica sobre como dar reset na senha de “sa” no SQL Express</a>, um assunto completamente diferente dos temas que costumo abordar normalmente. Fiz aquele post principalmente para guardar a dica, caso fosse necessária novamente no futuro. O que eu não esperava era que ela seria tão necessária: Desde quando postei até agora eu já utilizei ou indiquei aquele post 7 vezes aqui no serviço. </p>  <p><a title="Site oficial do SQL Server 2008" href="http://http://www.microsoft.com/sqlserver/2008/en/us/" target="_blank"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Microsoft SQL Server" border="0" alt="Microsoft SQL Server" src="http://lh6.ggpht.com/_33jXBude3Pw/THZf67VsQfI/AAAAAAAAA1c/ulBz0L8MHd8/image%5B40%5D.png?imgmax=800" width="299" height="86" /></a></p>  <p>Esse assunto se tornou importante aqui devido ao fato de que agora os computadores de novos funcionarios não serão mais formatados, a não ser que a instalação anterior esteja com problemas. Como tivemos uma onda de contratações recentemente, vários computadores que estavam guardados foram disponibilizados para os novos desenvolvedores e então o problema de tornou latente.</p>  <p>Isso me fez ver também que meu post anterior poderia ter seu passo a passo melhorado, pois nem todos os casos são iguais e nem todos os detalhes estavam bem claros. Por isso eu decidi escrever um novo post mais claro e detalhado para ficar mais fácil para as próximas pessoas que precisarem dessa dica.</p>  <p>Quando o SQL Server ou SQL Express é instalado em um computador junto ou por algum outro aplicativo (Visual Studio, Web Platform Installer), o grupo de administradores local da máquina não é adicionado automáticamente ao grupo de administradores do banco de dados. Então, quando um computador muda de dono, o novo dono não consegue ter acesso admin no próprio SQL, mesmo sendo administrador local, pois apenas o usuário anterior e o “sa” estão no grupo de administradores do SQL. </p>  <p>O SQL e o SQL Express têm um modo de execução chamada “Single User” que serve justamente para realizar reparos na instalação. Quando o SQL está rodando em modo “Single User”, todos os administradores locais são incluídos temporáriamente como administradores do banco de dados, mesmo que ele não esteja configurado assim. Isso torna possível conectar no banco e fazer as “correções” necessárias usando o usuário logado atualmente no computador. </p>  <p>Abaixo tem um passo a passo para realizar a correção e reassumir controle sobre o banco de dados.</p>
<ol>   <li>Obtenha o nome do serviço da instância do SQL que você deseja reparar. O serviço do SQL Server custuma se chamar MSSQLSERVER e o do SQL Express costuma se chamar MSSQL$SQLEXPRESS. Se você não tiver certeza, pode verificar o nome do serviço indo em “Painel de Controle > Ferramentas Administrativas > Serviços” e dando um duplo clique no serviço desejado você verá o nome dele:      <br /><a href="http://lh6.ggpht.com/_33jXBude3Pw/THZf92s452I/AAAAAAAAA1g/RwC8rjYHiqc/s1600-h/image%5B5%5D.png"><img style="border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Gerenciador de Serviços do Windows, com o serviço " SQL Server (SQLEXPRESS)" selecionado." border="0" alt="Gerenciador de Serviços do Windows, com o serviço " SQL Server (SQLEXPRESS)" selecionado." src="http://lh4.ggpht.com/_33jXBude3Pw/THZf_VNcbdI/AAAAAAAAA1k/fkYsyPHLbEY/image_thumb%5B3%5D.png?imgmax=800" width="590" height="327" /></a> <img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Janela de propriedades do serviço " SQL Server (SQLEXPRESS)", mostrando o nome do serviço, que nesse caso é "MSSQL$SQLEXPRESS" ." border="0" alt="Janela de propriedades do serviço " SQL Server (SQLEXPRESS)", mostrando o nome do serviço, que nesse caso é "MSSQL$SQLEXPRESS" ." src="http://lh3.ggpht.com/_33jXBude3Pw/THZgAYAHFbI/AAAAAAAAA1s/6nHDfoF1IYA/image%5B42%5D.png?imgmax=800" width="426" height="479" /> </li>    <li>Abra um prompt de comando em modo administrativo (“Run as Administrator” ou “Executar como Administrador”)      <br /><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Menu Iniciar, mostrando a opção " Executar como administrador" do programa "Prompt de Comando" " border="0" alt="Menu Iniciar, mostrando a opção " Executar como administrador" do programa "Prompt de Comando" " src="http://lh5.ggpht.com/_33jXBude3Pw/THZgBw3P1TI/AAAAAAAAA1w/ZzG8qsmO8ho/image%5B43%5D.png?imgmax=800" width="425" height="593" /> <img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Prompt de Comando aberto, mostrando que está sendo executado como Administrador" border="0" alt="Prompt de Comando aberto, mostrando que está sendo executado como Administrador" src="http://lh3.ggpht.com/_33jXBude3Pw/THZgC4StnGI/AAAAAAAAA10/ay7-nhPP31w/image%5B44%5D.png?imgmax=800" width="425" height="147" /> </li>    <li>Pare o serviço do SQL desejado executando o seguinte comando:      <pre class="highlight"><code>NET STOP NomeDoServicoPasso1</code></pre><br />No meu caso, o nome do serviço seria MSSQL$SQLEXPRESS. </li><br /><br />  <li>Reinicie o serviço do SQL em modo Single User com o seguinte comando: <br />    <pre class="highlight"><code>NET START NomeDoServicoPasso1 /m</code></pre><br />A partir de agora só é possível conectar nesse banco de dados com o usuário atual. </li><br /><br />  <li>Conecte no banco de dados utilizando o SQL Server Management Studio, mas <u>executando como Administrador</u> do mesmo modo que foi feito com o prompt de comando. Isso é necessário pois o SQL está executando em modo Single User, então ele só aceitará conexões do usuário que iniciou o serviço. <br /><br />    <br /><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: inline; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="Menu Iniciar, mostrando o programa " SQL Server Management Studio" com a opção "Executar como administrador" " border="0" alt="Menu Iniciar, mostrando o programa " SQL Server Management Studio" com a opção "Executar como administrador" " src="http://lh3.ggpht.com/_33jXBude3Pw/THZgD9VJqnI/AAAAAAAAA14/tctdWyu5h7M/image%5B47%5D.png?imgmax=800" width="432" height="246" /> </li><br /><br />  <li>No SQL Server Management Studio, execute as alterações desejadas no servidor (ex.: alteração da senha do usuário “sa”, inclusão do seu usuário no grupo “sysadmin”, inclusão do grupo de administradores local como sysadmin no SQL, etc…). Depois de feitas as alterações, feche o SQL Server Management Studio. </li><br /><br />  <li>Pare o serviço do SQL novamente, usando o mesmo comando executado no passo 3.<br />    <pre class="highlight"><code>NET STOP NomeDoServicoPasso1</code></pre><br />  </li><br /><br />  <li>Reinicie o serviço do SQL em modo normal, executando o mesmo comando do passo 4, mas sem o parâmetro /m no final. <br />    <pre class="highlight"><code>NET START NomeDoServicoPasso1</code></pre><br />  </li><br /><br />  <li>Pronto, pode voltar a usar seu servidor de banco de dados normalmente. </li><br /></ol><br /><br /><p>Os passos acima podem ser feitos para qualquer versão e instância de SQL Server ou SQL Express e também funcionam em versões anteriores do SQL.</p>
